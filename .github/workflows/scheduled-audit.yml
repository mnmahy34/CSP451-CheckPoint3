name: Daily Dependency Audit

on:
  schedule:
    - cron: "0 3 * * *" # every day at 3 AM UTC

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: npm ci

      - name: Run npm audit
        run: npm audit --json > audit.json

      - name: Create GitHub Issue if vulnerabilities found
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit.json'));
            if (audit.metadata.vulnerabilities.total > 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "Security Vulnerabilities Found",
                body: "Daily audit found vulnerabilities:\n\n```json\n" + JSON.stringify(audit.metadata.vulnerabilities, null, 2) + "\n```"
              });
            }
